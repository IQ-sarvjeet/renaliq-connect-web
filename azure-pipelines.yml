# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none           #set trigger to none if you want to stop auto-matic build everytime ypu update this branch
  #branches:
    #include:
      #- testing_5sept

stages:
  - stage: 'Build'
    displayName: 'Buildd the web appication'
    jobs:
      - job: 'Build'
        displayName: 'Build job'
        pool:
          vmImage: 'windows-latest'
          demands:
          - npm
        
        steps:
        - task: NodeTool@0
          displayName: 'Use Node 16.x'
          inputs:
            versionSpec: 16.x 
          
        - task: Npm@1
          displayName: 'npm custom'
          inputs:
            command: custom
            verbose: false
            customCommand: 'install -g @angular/cli'
        
        - task: Npm@1
          displayName: 'npm install'
          inputs:
            verbose: false
          
        - script: 'ng build '
          displayName: build
        - task: PublishPipelineArtifact@1
          displayName: 'Publish Pipeline Artifact'
          inputs:
            targetPath: 'dist/new-angular-app'
            artifact: drop

  - stage: 'Dev'
    displayName: 'Deploy to the dev environment'
    dependsOn: Build
    condition:  succeeded()
    jobs:
    - deployment: Deploy
      pool:
        vmImage: 'windows-latest'
      environment: dev
      variables:
      - group: uat
      strategy:
        runOnce:
          deploy:
            steps:

            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'current'
                artifactName: 'drop'
                targetPath: '$(Agent.BuildDirectory)/drop'
              
            - task: PowerShell@2
              inputs:
                targetType: 'inline'
                script: 'mkdir dist'

            - task: CopyFiles@2
              displayName: 'Copy Files to: $(System.DefaultWorkingDirectory)/dist'
              inputs:
                SourceFolder: '$(Agent.BuildDirectory)\drop'
                TargetFolder: '$(System.DefaultWorkingDirectory)/dist'

            - task: replacetokens@5
              inputs:
                rootDirectory: '$(System.DefaultWorkingDirectory)/dist'
                targetFiles: 'main.*.js'
                tokenPattern: 'custom'
                tokenPrefix: '_@_'
                tokenSuffix: '_@_'
            - task: AzureRmWebAppDeployment@4
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: 'Azure Development Subscription(16546ea7-0c0e-4810-9aa2-820727239256)'
                appType: 'webAppLinux'
                WebAppName: 'mdm-prototype'
                packageForLinux: '$(System.DefaultWorkingDirectory)/dist'
    
  - stage: 'prod'
    displayName: 'Deploy to the prod environment'
    dependsOn: Dev
    jobs:
    - deployment: Deploy
      pool:
        vmImage: 'windows-latest'
      environment: prod
      variables:
      - group: prod
      strategy:
        runOnce:
          deploy:
            steps:
            - task: DownloadPipelineArtifact@2
              inputs:
                buildType: 'current'
                artifactName: 'drop'
                targetPath: '$(Agent.BuildDirectory)/drop'

            - task: PowerShell@2
              inputs:
                targetType: 'inline'
                script: 'mkdir dist'

            - task: CopyFiles@2
              displayName: 'Copy Files to: $(System.DefaultWorkingDirectory)/dist'
              inputs:
                SourceFolder: '$(Agent.BuildDirectory)\drop'
                TargetFolder: '$(System.DefaultWorkingDirectory)/dist'

            - task: replacetokens@5
              inputs:
                rootDirectory: '$(System.DefaultWorkingDirectory)/dist'
                targetFiles: 'main.*.js'
                tokenPattern: 'custom'
                tokenPrefix: '_@_'
                tokenSuffix: '_@_'
            - task: AzureRmWebAppDeployment@4
              inputs:
                ConnectionType: 'AzureRM'
                azureSubscription: 'Azure Development Subscription(16546ea7-0c0e-4810-9aa2-820727239256)'
                appType: 'webAppLinux'
                WebAppName: 'mdm-prototype'
                packageForLinux: '$(System.DefaultWorkingDirectory)/dist'
